<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maneuvering Board – Speed/Stationing Triangle with Range Rings</title>

  <!--
    Generated by Christopher King with help from ChatGPT.

    UTILIZED RESOURCES / CREDIT:
    - U.S. Navy maneuvering board and relative motion concepts (Speed Triangle / Stationing Triangle),
      as taught in standard maritime navigation and seamanship curricula.
    - General trigonometry / vector math and standard radar/range-ring plotting conventions.
    - SVG/HTML5/JavaScript standards maintained by W3C/WHATWG and implemented by modern web browsers.

    Note: This is an educational visualization and does not constitute an official navigation tool.
  -->

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121a24;
      --text:#e8eef6;
      --muted:#9fb0c3;
      --grid:#1d2a3a;

      --own:#3ddc97;
      --tgt:#ff6b6b;
      --rel:#61a5ff;
      --accent:#f7d774;
      --contact:#d9d9d9;
    }

    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    *, *:before, *:after { box-sizing:border-box; }

    .wrap{display:grid; grid-template-columns: 440px 1fr; gap:14px; height:100%; padding:14px;}

    .panel{
      background:var(--panel);
      border:1px solid #1b2838;
      border-radius:12px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      overflow:auto;
      min-width: 320px;
    }
    h1{font-size:16px; margin:0 0 10px 0;}
    h2{font-size:13px; margin:14px 0 8px 0; color:var(--text);}
    .small{color:var(--muted); font-size:12px; line-height:1.35;}

    .row{display:flex; gap:10px; align-items:center; margin:10px 0; min-width:0;}
    .row label{flex:1; font-size:13px; min-width:0;}
    .row input[type="range"]{flex:1.2; min-width:0;}

    /* Keep numeric entry boxes neatly bound inside the panel */
    .row input[type="number"]{
      width:70px; max-width:70px;
      background:#0e1620; color:var(--text);
      border:1px solid #26374b; border-radius:8px;
      padding:7px 8px;
      min-width:0;
    }
    .row select, .row button{
      background:#0e1620; color:var(--text);
      border:1px solid #26374b; border-radius:10px;
      padding:9px 10px;
    }
    .row button{cursor:pointer; user-select:none; white-space:nowrap;}
    .row button:hover{border-color:#3a5470;}
    .row button.primary{border-color:#3a5470;}

    .box{
      margin-top:10px; padding:10px;
      border:1px solid #1b2838; border-radius:10px; background:#0e1620;
    }

    .legend{margin-top:12px; display:grid; gap:8px; font-size:13px;}
    .legItem{display:flex; align-items:center; gap:10px;}
    .swatch{width:14px; height:14px; border-radius:4px;}
    .swatch.own{background:var(--own);}
    .swatch.tgt{background:var(--tgt);}
    .swatch.rel{background:var(--rel);}
    .swatch.ct{background:var(--contact);}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; padding:2px 6px; border:1px solid #2b3f57; border-radius:6px; color:var(--muted);}

    .viz{
      background: radial-gradient(1200px 700px at 50% 40%, rgba(97,165,255,.08), transparent 55%),
                  linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%);
      border:1px solid #1b2838;
      border-radius:12px;
      overflow:hidden;
      position:relative;
      min-height:520px;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .badge{
      position:absolute; top:12px; left:12px;
      background:rgba(14,22,32,.85);
      border:1px solid #26374b;
      border-radius:999px;
      padding:7px 10px;
      font-size:12px; color:var(--muted);
      display:flex; gap:10px; align-items:center;
      backdrop-filter: blur(6px);
      user-select:none;
      z-index:3;
    }
    .badge b{color:var(--text); font-weight:600;}

    .scopeNote{
      position:absolute;
      right:12px;
      bottom:12px;
      background:rgba(14,22,32,.85);
      border:1px solid #26374b;
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(6px);
      user-select:none;
      z-index:3;
      max-width: 380px;
      text-align:right;
      line-height:1.25;
    }

    /* Course wheel */
    .dialRow{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:12px;
      align-items:center;
      margin:10px 0;
      min-width:0;
    }
    .dialWrap{width:110px; height:110px; display:flex; align-items:center; justify-content:center;}
    .dial svg{overflow:visible; touch-action:none;}
    .dial text{user-select:none;}
    .dialHint{color:var(--muted); font-size:12px; margin-top:6px;}
  </style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <h1>Maneuvering Board Triangle Visualization</h1>
    <div class="small">
      Use the course wheels, speed controls, and playback controls to visualize true motion and relative motion.
      Drag vertices <b>R</b> and <b>M</b> to set vectors directly. Hold <span class="kbd">Shift</span> to snap course to 5°.
    </div>

    <div class="row">
      <label for="mode"><b>Mode</b></label>
      <select id="mode">
        <option value="speed">Speed Triangle</option>
        <option value="stationing">Stationing Triangle</option>
      </select>
    </div>

    <div class="box">
      <div class="small" style="margin-bottom:8px;"><b>Range Rings (MOBOARD-style)</b></div>
      <div class="row">
        <label><b>Scale</b> (×)</label>
        <select id="rangeScale">
          <option value="1" selected>1×</option>
          <option value="2">2×</option>
          <option value="3">3×</option>
          <option value="4">4×</option>
          <option value="5">5×</option>
        </select>
      </div>
      <div class="row">
        <label><b>Ring spacing</b> (px per ring)</label>
        <input id="ringPx" type="number" min="14" max="70" step="1" value="28" />
      </div>
      <div class="small">
        Scale changes <b>ring labels only</b>; vector geometry stays consistent relative to the rings.
      </div>
    </div>

    <div class="box">
      <div class="small" style="margin-bottom:8px;"><b>Playback</b></div>
      <div class="row">
        <button id="playPause" class="primary">Play</button>
        <button id="rewind">Rewind</button>
      </div>
      <div class="row">
        <label>Play speed</label>
        <select id="playSpeed">
          <option value="0.5">0.5×</option>
          <option value="1" selected>1×</option>
          <option value="2">2×</option>
          <option value="5">5×</option>
          <option value="10">10×</option>
        </select>
        <button id="stepBack">Step -</button>
        <button id="stepFwd">Step +</button>
      </div>
      <div class="small" id="speedNote">
        At <b>1×</b>: 1 real second = 15 simulated seconds.
      </div>
    </div>

    <div class="box">
      <div class="small" style="margin-bottom:8px;"><b>Own / True Vector</b></div>
      <div class="dialRow">
        <div class="dialWrap"><div class="dial" id="ownDial"></div></div>
        <div>
          <div class="row" style="margin:0;">
            <label>Course (°T)</label>
            <input id="ownCNum" type="number" min="0" max="359" step="1" value="90" />
          </div>
          <div class="row">
            <label>Speed (kts)</label>
            <input id="ownS" type="range" min="0" max="35" step="0.5" value="5" />
            <input id="ownSNum" type="number" min="0" max="35" step="0.5" value="5" />
          </div>
          <div class="dialHint">Drag the needle to set course.</div>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="small" style="margin-bottom:8px;"><b>Other Ship / Guide Vector</b></div>
      <div class="dialRow">
        <div class="dialWrap"><div class="dial" id="tgtDial"></div></div>
        <div>
          <div class="row" style="margin:0;">
            <label>Course (°T)</label>
            <input id="tgtCNum" type="number" min="0" max="359" step="1" value="45" />
          </div>
          <div class="row">
            <label>Speed (kts)</label>
            <input id="tgtS" type="range" min="0" max="35" step="0.5" value="10" />
            <input id="tgtSNum" type="number" min="0" max="35" step="0.5" value="10" />
          </div>
          <div class="row">
            <label>Bearing (°T)</label>
            <input id="tgtB" type="range" min="0" max="359" step="1" value="0" />
            <input id="tgtBNum" type="number" min="0" max="359" step="1" value="0" />
          </div>
          <div class="row">
            <label>Range (kyd)</label>
            <input id="tgtR" type="range" min="0" max="60" step="0.1" value="0" />
            <input id="tgtRNum" type="number" min="0" max="60" step="0.1" value="0" />
          </div>
          <div class="dialHint">Drag the needle to set course.</div>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="small" style="margin-bottom:8px;"><b>Initial Contact Position</b></div>
      <div class="row">
        <label>Bearing (°T)</label>
        <input id="ctB" type="range" min="0" max="359" step="1" value="320" />
        <input id="ctBNum" type="number" min="0" max="359" step="1" value="320" />
      </div>
      <div class="row">
        <label>Range (kyd)</label>
        <input id="ctR" type="range" min="0" max="60" step="0.1" value="6.0" />
        <input id="ctRNum" type="number" min="0" max="60" step="0.1" value="6.0" />
      </div>
      <div class="small">Range is expressed in <b>thousands of yards</b> (kyd).</div>
    </div>

    <div class="legend">
      <div class="legItem"><span class="swatch own"></span> <span id="legOwn">e→R = ours (true)</span></div>
      <div class="legItem"><span class="swatch tgt"></span> <span id="legTgt">e→M = other (true)</span></div>
      <div class="legItem"><span class="swatch rel"></span> <span>R→M = relative motion</span></div>
      <div class="legItem"><span class="swatch ct"></span> <span>Contact + relative vector copy</span></div>
    </div>

    <h2>Credits</h2>
    <div class="small">
      Generated by <b>Christopher King</b> with help from <b>ChatGPT</b>.<br>
      Resources: U.S. Navy maneuvering board relative motion concepts (speed/stationing triangles); standard vector math; HTML5/SVG/JavaScript web standards maintained by W3C/WHATWG and implemented by modern browsers.
    </div>
  </div>

  <div class="viz">
    <div class="badge">
      <span>Mode: <b id="badgeMode">Speed Triangle</b></span>
      <span>•</span>
      <span>Sim time: <b id="badgeTime">00:00</b></span>
      <span>•</span>
      <span>Speed: <b id="badgeSpeed">1×</b></span>
    </div>

    <div class="scopeNote" id="scopeNote">
      Range rings are in thousands of yards according to the scale.
    </div>

    <svg id="svg" width="100%" height="100%" viewBox="-360 -320 720 640"
         xmlns="http://www.w3.org/2000/svg" style="display:block; touch-action:none;">
      <defs>
        <!-- Arrowheads reduced ~1/3 size for better visibility at low speeds -->
        <marker id="arrowOwn" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="3" markerHeight="3" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--own)"/>
        </marker>
        <marker id="arrowTgt" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="3" markerHeight="3" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--tgt)"/>
        </marker>
        <marker id="arrowRel" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="3" markerHeight="3" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--rel)"/>
        </marker>
        <marker id="arrowCtRel" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="3" markerHeight="3" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--contact)"/>
        </marker>
      </defs>

      <g id="scope"></g>

      <g stroke-linecap="round" stroke-linejoin="round" opacity="0.95">
        <line id="lineER" x1="0" y1="0" x2="0" y2="0" stroke="var(--own)" stroke-width="4" marker-end="url(#arrowOwn)"/>
        <line id="lineEM" x1="0" y1="0" x2="0" y2="0" stroke="var(--tgt)" stroke-width="4" marker-end="url(#arrowTgt)"/>
        <line id="lineRM" x1="0" y1="0" x2="0" y2="0" stroke="var(--rel)" stroke-width="4" marker-end="url(#arrowRel)"/>
      </g>

      <g>
        <line id="bearingLine" x1="0" y1="0" x2="0" y2="0" stroke="var(--grid)" stroke-width="2" opacity="0.8"/>
        <polyline id="trail" points="" fill="none" stroke="var(--contact)" stroke-width="2" opacity="0.35"/>
        <line id="ctRel" x1="0" y1="0" x2="0" y2="0" stroke="var(--contact)" stroke-width="3" opacity="0.85" marker-end="url(#arrowCtRel)"/>
        <circle id="ct" cx="0" cy="0" r="6.5" fill="var(--contact)" stroke="#0b0f14" stroke-width="2"/>
      </g>

      <g>
        <circle id="ptE" cx="0" cy="0" r="6" fill="#ffffff"/>
        <circle id="ptR" cx="0" cy="0" r="7" fill="var(--own)" stroke="#0b0f14" stroke-width="2" cursor="grab"/>
        <circle id="ptM" cx="0" cy="0" r="7" fill="var(--tgt)" stroke="#0b0f14" stroke-width="2" cursor="grab"/>
      </g>

      <g font-size="14" font-weight="650" fill="var(--text)" style="user-select:none;">
        <text id="labE" x="10" y="18">e</text>
        <text id="labR" x="10" y="18">R</text>
        <text id="labM" x="10" y="18">M</text>
      </g>

      <g id="flag" opacity="0">
        <line x1="0" y1="0" x2="0" y2="-28" stroke="var(--accent)" stroke-width="3" />
        <path d="M 0 -28 L 26 -22 L 0 -16 Z" fill="var(--accent)"/>
      </g>

      <g transform="translate(-340,285)" font-size="12" fill="var(--muted)">
        <text id="ro1" x="0" y="0"></text>
        <text id="ro2" x="0" y="18"></text>
        <text id="ro3" x="0" y="36"></text>
        <text id="ro4" x="0" y="54"></text>
      </g>
    </svg>
  </div>
</div>

<script>
(() => {
  // ---------- Helpers ----------
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const mag = (x,y)=>Math.hypot(x,y);

  // Course degT (0=N, 90=E) to nav unit vector (East,North)
  const courseToVec = (deg)=>{
    const r = deg*Math.PI/180;
    return { x: Math.sin(r), y: Math.cos(r) }; // x=E, y=N
  };
  const vecToCourse = (xE,yN)=>{
    let deg = Math.atan2(xE,yN)*180/Math.PI;
    if(deg<0) deg+=360;
    return deg;
  };

  // nav (E,N) -> svg (x right, y down)
  const navToSvg = (p, pxPerKyd)=>({ x: p.x*pxPerKyd, y: -p.y*pxPerKyd });
  const svgToNav = (p, pxPerKyd)=>({ x: p.x/pxPerKyd, y: -p.y/pxPerKyd });

  const fmtCourse = (c)=>String(Math.round(c)).padStart(3,'0')+'°T';
  const fmtTime = (hours)=>{
    const totalSec = Math.max(0, Math.round(hours*3600));
    const mm = String(Math.floor((totalSec%3600)/60)).padStart(2,'0');
    const hh = String(Math.floor(totalSec/3600)).padStart(2,'0');
    return `${hh}:${mm}`;
  };

  // Unit conversion: 1 knot = 2000 yd/hr = 2 kyd/hr
  const KNOT_TO_KYD_PER_HR = 2;

  // Vector plotting time step: 6 minutes => 5 kts reaches 1 kyd
  const VECTOR_TIME_MIN = 6;
  const VECTOR_TIME_HR = VECTOR_TIME_MIN / 60;

  // ---------- State ----------
  const state = {
    mode: 'speed',

    // Range ring settings:
    // - ringPx controls spacing between adjacent rings (pixels per ring)
    // - rangeScale controls label values in kyd (thousands of yards) per ring (labels only)
    rangeScale: 1,     // 1×..5× (label step)
    ringPx: 28,        // pixels per ring

    own: { c: 90, s: 5 },   // knots
    tgt: { c: 45, s: 10 },  // knots
    tgtPos: { brg: 0, rngKyd: 0 },
    tgtPosNavKyd: {x:0,y:0},
    contact0: { brg: 320, rngKyd: 6.0 }, // initial contact range in kyd

    sim: {
      playing: false,
      speedMult: 1,
      tHours: 0,

      // Slower sim: 1 sec real = 15 sec simulated at 1×
      baseHoursPerSec: 1/240,

      trailEveryMin: 2,
      lastTrailMin: 0,

      // Current contact position in kyd (integrated forward)
      contactNavKyd: {x:0,y:0},
      trailPtsKyd: []
    }
  };

  function contactInitialNavKyd(){
    const u = courseToVec(state.contact0.brg);
    return { x: u.x*state.contact0.rngKyd, y: u.y*state.contact0.rngKyd };
  }

  function setTgtPosNavFromPolar(){
    const u = courseToVec(state.tgtPos.brg);
    state.tgtPosNavKyd = { x: u.x * state.tgtPos.rngKyd, y: u.y * state.tgtPos.rngKyd };
  }

  function setTgtPosPolarFromNav(nav){
    const rng = clamp(mag(nav.x, nav.y), 0, 60);
    const brg = rng>1e-9 ? vecToCourse(nav.x, nav.y) : state.tgtPos.brg;
    state.tgtPos = { brg: ((Math.round(brg)%360)+360)%360, rngKyd: rng };
    setTgtPosNavFromPolar();
  }

  function resetSim(){
    state.sim.tHours = 0;
    state.sim.lastTrailMin = 0;
    state.sim.contactNavKyd = contactInitialNavKyd();
    state.sim.trailPtsKyd = [ { ...state.sim.contactNavKyd } ];
  }

  // ---------- DOM ----------
  const svg = document.getElementById('svg');
  const scopeG = document.getElementById('scope');

  const modeSel = document.getElementById('mode');
  const badgeMode = document.getElementById('badgeMode');
  const badgeTime = document.getElementById('badgeTime');
  const badgeSpeed = document.getElementById('badgeSpeed');

  const rangeScaleSel = document.getElementById('rangeScale');
  const ringPxNum = document.getElementById('ringPx');

  const playPause = document.getElementById('playPause');
  const rewind = document.getElementById('rewind');
  const playSpeed = document.getElementById('playSpeed');
  const stepBack = document.getElementById('stepBack');
  const stepFwd = document.getElementById('stepFwd');

  const speedNote = document.getElementById('speedNote');

  const ownCNum = document.getElementById('ownCNum');
  const ownS = document.getElementById('ownS');
  const ownSNum = document.getElementById('ownSNum');

  const tgtCNum = document.getElementById('tgtCNum');
  const tgtS = document.getElementById('tgtS');
  const tgtSNum = document.getElementById('tgtSNum');
  const tgtB = document.getElementById('tgtB');
  const tgtBNum = document.getElementById('tgtBNum');
  const tgtR = document.getElementById('tgtR');
  const tgtRNum = document.getElementById('tgtRNum');

  const ctB = document.getElementById('ctB');
  const ctBNum = document.getElementById('ctBNum');
  const ctR = document.getElementById('ctR');
  const ctRNum = document.getElementById('ctRNum');

  const legOwn = document.getElementById('legOwn');
  const legTgt = document.getElementById('legTgt');

  const lineER = document.getElementById('lineER');
  const lineEM = document.getElementById('lineEM');
  const lineRM = document.getElementById('lineRM');

  const bearingLine = document.getElementById('bearingLine');
  const ct = document.getElementById('ct');
  const ctRel = document.getElementById('ctRel');
  const trail = document.getElementById('trail');

  const ptE = document.getElementById('ptE');
  const ptR = document.getElementById('ptR');
  const ptM = document.getElementById('ptM');
  const labE = document.getElementById('labE');
  const labR = document.getElementById('labR');
  const labM = document.getElementById('labM');
  const flag = document.getElementById('flag');

  const ro1 = document.getElementById('ro1');
  const ro2 = document.getElementById('ro2');
  const ro3 = document.getElementById('ro3');
  const ro4 = document.getElementById('ro4');

  // ---------- Course Dial ----------
  function makeCourseDial(containerId, getCourse, setCourse, colorVar){
    const size = 100, r = 44, cx = size/2, cy = size/2;
    const wrap = document.getElementById(containerId);
    wrap.innerHTML = `
      <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
        <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="var(--grid)" stroke-width="3" opacity="0.9"/>
        <circle cx="${cx}" cy="${cy}" r="${r-10}" fill="none" stroke="var(--grid)" stroke-width="1.5" opacity="0.5"/>
        <line id="needle" x1="${cx}" y1="${cy}" x2="${cx}" y2="${cy-r+6}"
              stroke="${colorVar}" stroke-width="4" stroke-linecap="round"/>
        <circle cx="${cx}" cy="${cy}" r="5" fill="${colorVar}" />
        <text x="${cx}" y="${cy+6}" text-anchor="middle" font-size="12" fill="var(--muted)">COURSE</text>
        <text id="read" x="${cx}" y="${cy-18}" text-anchor="middle" font-size="14" fill="var(--text)" font-weight="650">000</text>
      </svg>
    `;
    const svgEl = wrap.querySelector('svg');
    const needle = wrap.querySelector('#needle');
    const read = wrap.querySelector('#read');

    const update = () => {
      const c = ((Math.round(getCourse())%360)+360)%360;
      read.textContent = String(c).padStart(3,'0');
      const rad = (c*Math.PI)/180;
      const x = cx + Math.sin(rad)*(r-10);
      const y = cy - Math.cos(rad)*(r-10);
      needle.setAttribute('x2', x);
      needle.setAttribute('y2', y);
    };

    function courseFromPointer(evt){
      const rect = svgEl.getBoundingClientRect();
      const x = evt.clientX - rect.left;
      const y = evt.clientY - rect.top;
      const dx = x - cx;
      const dy = cy - y;
      let deg = Math.atan2(dx, dy) * 180/Math.PI;
      if(deg < 0) deg += 360;
      if(evt.shiftKey) deg = Math.round(deg/5)*5;
      return deg;
    }

    let dragging = false;
    svgEl.addEventListener('pointerdown', (evt)=>{
      dragging = true;
      svgEl.setPointerCapture?.(evt.pointerId);
      setCourse(courseFromPointer(evt));
      update();
      evt.preventDefault();
    });
    svgEl.addEventListener('pointermove', (evt)=>{
      if(!dragging) return;
      setCourse(courseFromPointer(evt));
      update();
      evt.preventDefault();
    });
    const end = (evt)=>{
      dragging = false;
      try{ svgEl.releasePointerCapture?.(evt.pointerId); }catch(e){}
    };
    svgEl.addEventListener('pointerup', end);
    svgEl.addEventListener('pointercancel', end);
    svgEl.addEventListener('pointerleave', end);

    return { update };
  }

  const ownDial = makeCourseDial(
    'ownDial',
    ()=>state.own.c,
    (v)=>{ state.own.c = ((Math.round(v)%360)+360)%360; ownCNum.value = state.own.c; render(); },
    'var(--own)'
  );
  const tgtDial = makeCourseDial(
    'tgtDial',
    ()=>state.tgt.c,
    (v)=>{ state.tgt.c = ((Math.round(v)%360)+360)%360; tgtCNum.value = state.tgt.c; render(); },
    'var(--tgt)'
  );

  // ---------- Rates and Display Vectors ----------
  function computeRatesKydHr(){
    const oU = courseToVec(state.own.c);
    const tU = courseToVec(state.tgt.c);

    const Rrate = { x: oU.x*state.own.s*KNOT_TO_KYD_PER_HR, y: oU.y*state.own.s*KNOT_TO_KYD_PER_HR }; // kyd/hr
    const Mrate = { x: tU.x*state.tgt.s*KNOT_TO_KYD_PER_HR, y: tU.y*state.tgt.s*KNOT_TO_KYD_PER_HR }; // kyd/hr
    const RMrate = { x: Mrate.x - Rrate.x, y: Mrate.y - Rrate.y }; // kyd/hr
    return { e:{x:0,y:0}, Rrate, Mrate, RMrate };
  }

  function computeDisplayVectorsKyd(){
    const {e, Rrate, Mrate, RMrate} = computeRatesKydHr();
    const R = { x: Rrate.x*VECTOR_TIME_HR, y: Rrate.y*VECTOR_TIME_HR }; // kyd
    const M = { x: Mrate.x*VECTOR_TIME_HR, y: Mrate.y*VECTOR_TIME_HR }; // kyd
    const RM = { x: RMrate.x*VECTOR_TIME_HR, y: RMrate.y*VECTOR_TIME_HR }; // kyd
    return { e, R, M, RM, RMrate };
  }

  // ---------- Range Rings / Radials ----------
  // FIXED GEOMETRY: 1 kyd is always "ringPx" pixels.
  // Scale ONLY changes ring labels (n * scale).
  function kydToPxFactor(){
    return state.ringPx; // px per 1 kyd
  }

  function drawScope(){
    scopeG.innerHTML = '';

    const ringCount = 10;
    const pxPerKyd = kydToPxFactor();

    // Geometry outer radius in kyd stays fixed (10 kyd); labels scale independently.
    const outerKyd = ringCount;

    // 1) Radial dotted lines every 10 degrees with labels centered on the radial
    for(let deg=0; deg<360; deg+=10){
      const u = courseToVec(deg);
      const p1s = navToSvg({ x:u.x*outerKyd, y:u.y*outerKyd }, pxPerKyd);

      const ln = document.createElementNS("http://www.w3.org/2000/svg","line");
      ln.setAttribute('x1',0); ln.setAttribute('y1',0);
      ln.setAttribute('x2',p1s.x); ln.setAttribute('y2',p1s.y);
      ln.setAttribute('stroke','var(--grid)');
      ln.setAttribute('stroke-width', (deg%30===0) ? '1.4' : '1.0');
      ln.setAttribute('opacity', (deg%30===0) ? '0.55' : '0.28');
      ln.setAttribute('stroke-dasharray', (deg%30===0) ? '4 6' : '2 7');
      scopeG.appendChild(ln);

      const labelKyd = outerKyd + 0.35;
      const pLab = navToSvg({ x:u.x*labelKyd, y:u.y*labelKyd }, pxPerKyd);

      const tx = document.createElementNS("http://www.w3.org/2000/svg","text");
      tx.setAttribute('x', pLab.x);
      tx.setAttribute('y', pLab.y);
      tx.setAttribute('text-anchor','middle');
      tx.setAttribute('dominant-baseline','middle');
      tx.setAttribute('font-size', (deg%30===0) ? '11' : '10');
      tx.setAttribute('fill','var(--muted)');
      tx.setAttribute('opacity', (deg%30===0) ? '0.85' : '0.5');
      tx.textContent = String(deg).padStart(3,'0');
      scopeG.appendChild(tx);
    }

    // 2) Rings 1–10 (fixed radii), labels (n * scale)
    for(let i=1; i<=ringCount; i++){
      const radiusPx = i * state.ringPx;
      const labelVal = i * state.rangeScale;

      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute('cx',0); c.setAttribute('cy',0);
      c.setAttribute('r', radiusPx);
      c.setAttribute('fill','none');
      c.setAttribute('stroke','var(--grid)');
      c.setAttribute('stroke-width', i===ringCount ? '1.8' : '1.1');
      c.setAttribute('opacity', i===ringCount ? '0.9' : '0.45');
      scopeG.appendChild(c);

      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute('x', 6);
      t.setAttribute('y', -radiusPx + 14);
      t.setAttribute('font-size','12');
      t.setAttribute('fill','var(--muted)');
      t.textContent = `${labelVal}`;
      scopeG.appendChild(t);
    }

    // 3) Cardinal ticks at outer ring
    const cardinals = [0, 90, 180, 270];

    cardinals.forEach((deg)=>{
      const u = courseToVec(deg);
      const p1 = navToSvg({x:u.x*outerKyd, y:u.y*outerKyd}, pxPerKyd);
      const p0 = navToSvg({x:u.x*(outerKyd-0.6), y:u.y*(outerKyd-0.6)}, pxPerKyd);

      const ln = document.createElementNS("http://www.w3.org/2000/svg","line");
      ln.setAttribute('x1',p0.x); ln.setAttribute('y1',p0.y);
      ln.setAttribute('x2',p1.x); ln.setAttribute('y2',p1.y);
      ln.setAttribute('stroke','var(--grid)');
      ln.setAttribute('stroke-width','2');
      ln.setAttribute('opacity','0.95');
      scopeG.appendChild(ln);
    });
  }

  // ---------- Rendering ----------
  function setLine(el,a,b){
    el.setAttribute('x1',a.x); el.setAttribute('y1',a.y);
    el.setAttribute('x2',b.x); el.setAttribute('y2',b.y);
  }
  function setCircle(el,p){
    el.setAttribute('cx',p.x); el.setAttribute('cy',p.y);
  }
  function setLabel(el,p,txt){
    el.textContent = txt;
    el.setAttribute('x', p.x+10);
    el.setAttribute('y', p.y+18);
  }

  function updateLegendAndModeUI(){
    if(state.mode==='speed'){
      badgeMode.textContent='Speed Triangle';
      legOwn.textContent='e→R = ours (true)';
      legTgt.textContent='e→M = other (true)';
      flag.setAttribute('opacity','0');
    }else{
      badgeMode.textContent='Stationing Triangle';
      legOwn.textContent='e→M = ours (true)';
      legTgt.textContent='e→R = guide (true)';
      flag.setAttribute('opacity','1');
    }
  }

  function render(){
    rangeScaleSel.value = String(state.rangeScale);
    ringPxNum.value = state.ringPx;

    ownCNum.value = state.own.c;
    ownS.value = state.own.s; ownSNum.value = state.own.s;

    tgtCNum.value = state.tgt.c;
    tgtS.value = state.tgt.s; tgtSNum.value = state.tgt.s;
    tgtB.value = state.tgtPos.brg; tgtBNum.value = state.tgtPos.brg;
    tgtR.value = state.tgtPos.rngKyd; tgtRNum.value = state.tgtPos.rngKyd;

    ctB.value = state.contact0.brg; ctBNum.value = state.contact0.brg;
    ctR.value = state.contact0.rngKyd; ctRNum.value = state.contact0.rngKyd;

    badgeTime.textContent = fmtTime(state.sim.tHours);
    badgeSpeed.textContent = `${state.sim.speedMult}×`;

    speedNote.innerHTML = `At <b>1×</b>: 1 real second = 15 simulated seconds.`;

    updateLegendAndModeUI();
    drawScope();
    ownDial.update();
    tgtDial.update();

    const pxPerKyd = kydToPxFactor();

    const {e, R, M, RM, RMrate} = computeDisplayVectorsKyd();

    const tgtBaseNav = state.tgtPosNavKyd;
    const mBaseSvg = navToSvg(tgtBaseNav, pxPerKyd);
    const mTipNav = { x: tgtBaseNav.x + M.x, y: tgtBaseNav.y + M.y };
    const mTipSvg = navToSvg(mTipNav, pxPerKyd);

    const eS = navToSvg(e, pxPerKyd);
    const rS = navToSvg(R, pxPerKyd);
    const mS = mTipSvg;

    setCircle(ptE,eS); setCircle(ptR,rS); setCircle(ptM,mS);
    setLabel(labE,eS,'e'); setLabel(labR,rS,'R'); setLabel(labM,mS,'M');
    flag.setAttribute('transform',`translate(${eS.x},${eS.y})`);

    if(state.mode==='speed'){
      setLine(lineER,eS,rS); setLine(lineEM,mBaseSvg,mS);
      lineER.setAttribute('stroke','var(--own)'); lineER.setAttribute('marker-end','url(#arrowOwn)');
      lineEM.setAttribute('stroke','var(--tgt)'); lineEM.setAttribute('marker-end','url(#arrowTgt)');
      ptR.setAttribute('fill','var(--own)');
      ptM.setAttribute('fill','var(--tgt)');
    }else{
      setLine(lineER,eS,rS); setLine(lineEM,mBaseSvg,mS);
      lineER.setAttribute('stroke','var(--tgt)'); lineER.setAttribute('marker-end','url(#arrowTgt)');
      lineEM.setAttribute('stroke','var(--own)'); lineEM.setAttribute('marker-end','url(#arrowOwn)');
      ptR.setAttribute('fill','var(--tgt)');
      ptM.setAttribute('fill','var(--own)');
    }
    setLine(lineRM,rS,mS);

    const relRateKydHr = mag(RMrate.x,RMrate.y);
    const relKts = relRateKydHr / KNOT_TO_KYD_PER_HR;
    const relC = relRateKydHr>1e-9 ? vecToCourse(RMrate.x,RMrate.y) : 0;

    ro1.textContent = `Own: C ${fmtCourse(state.own.c)}, S ${state.own.s.toFixed(1)} kts`;
    ro2.textContent = `Other: C ${fmtCourse(state.tgt.c)}, S ${state.tgt.s.toFixed(1)} kts`;
    ro3.textContent = `Relative: C ${fmtCourse(relC)}, S ${relKts.toFixed(1)} kts (vectors = ${VECTOR_TIME_MIN} min)`;
    ro4.textContent = `Contact0: Brg ${fmtCourse(state.contact0.brg)}, Rng ${state.contact0.rngKyd.toFixed(1)} kyd`;

    const ctSvg = navToSvg(state.sim.contactNavKyd, pxPerKyd);
    setCircle(ct, ctSvg);
    setLine(bearingLine, eS, ctSvg);

    const ctRelEndNav = { x: state.sim.contactNavKyd.x + RM.x, y: state.sim.contactNavKyd.y + RM.y };
    const ctRelEndSvg = navToSvg(ctRelEndNav, pxPerKyd);
    setLine(ctRel, ctSvg, ctRelEndSvg);

    const pts = state.sim.trailPtsKyd.map(p => {
      const s = navToSvg(p, pxPerKyd);
      return `${s.x.toFixed(1)},${s.y.toFixed(1)}`;
    }).join(' ');
    trail.setAttribute('points', pts);
  }

  // ---------- UI events ----------
  modeSel.addEventListener('change', ()=>{ state.mode = modeSel.value; render(); });

  rangeScaleSel.addEventListener('change', ()=>{
    state.rangeScale = clamp(parseInt(rangeScaleSel.value,10)||1, 1, 5);
    render();
  });
  ringPxNum.addEventListener('input', ()=>{
    state.ringPx = clamp(parseInt(ringPxNum.value,10)||28, 14, 70);
    render();
  });

  function bindPair(rangeEl, numEl, onChange){
    rangeEl.addEventListener('input', ()=>onChange(parseFloat(rangeEl.value)));
    numEl.addEventListener('input', ()=>onChange(parseFloat(numEl.value)));
  }

  bindPair(ownS, ownSNum, (v)=>{ state.own.s = clamp(v,0,35); render(); });
  bindPair(tgtS, tgtSNum, (v)=>{ state.tgt.s = clamp(v,0,35); render(); });
  bindPair(tgtB, tgtBNum, (v)=>{ state.tgtPos.brg = ((Math.round(v)%360)+360)%360; setTgtPosNavFromPolar(); resetSim(); render(); });
  bindPair(tgtR, tgtRNum, (v)=>{ state.tgtPos.rngKyd = clamp(v,0,60); setTgtPosNavFromPolar(); resetSim(); render(); });

  ownCNum.addEventListener('input', ()=>{
    state.own.c = ((Math.round(parseFloat(ownCNum.value)||0)%360)+360)%360;
    ownDial.update();
    render();
  });
  tgtCNum.addEventListener('input', ()=>{
    state.tgt.c = ((Math.round(parseFloat(tgtCNum.value)||0)%360)+360)%360;
    tgtDial.update();
    render();
  });

  bindPair(ctB, ctBNum, (v)=>{ state.contact0.brg = ((Math.round(v)%360)+360)%360; resetSim(); render(); });
  bindPair(ctR, ctRNum, (v)=>{ state.contact0.rngKyd = clamp(v,0,60); resetSim(); render(); });

  playSpeed.addEventListener('change', ()=>{
    state.sim.speedMult = parseFloat(playSpeed.value);
    render();
  });

  playPause.addEventListener('click', ()=>{
    state.sim.playing = !state.sim.playing;
    playPause.textContent = state.sim.playing ? 'Pause' : 'Play';
    playPause.classList.toggle('primary', state.sim.playing);
  });

  rewind.addEventListener('click', ()=>{
    state.sim.playing = false;
    playPause.textContent = 'Play';
    playPause.classList.add('primary');
    resetSim();
    render();
  });

  function step(minutes){
    const dtH = minutes/60;
    const {RMrate} = computeRatesKydHr();

    state.sim.contactNavKyd.x += RMrate.x * dtH;
    state.sim.contactNavKyd.y += RMrate.y * dtH;
    state.sim.tHours = clamp(state.sim.tHours + dtH, 0, 999);

    state.sim.trailPtsKyd.push({ ...state.sim.contactNavKyd });
    if(state.sim.trailPtsKyd.length > 800) state.sim.trailPtsKyd.shift();
    render();
  }
  stepBack.addEventListener('click', ()=>step(-1));
  stepFwd.addEventListener('click', ()=>step(1));

  // ---------- Dragging R/M sets course & speed ----------
  let dragging = null; // 'R' | 'M'
  function svgPointFromEvent(evt){
    const pt = svg.createSVGPoint();
    pt.x = evt.clientX; pt.y = evt.clientY;
    const p = pt.matrixTransform(svg.getScreenCTM().inverse());
    return { x: p.x, y: p.y };
  }

  function applyDrag(which, pSvg, snap5){
    const pxPerKyd = kydToPxFactor();
    const pNav = svgToNav(pSvg, pxPerKyd); // kyd

    const anchor = (which==='M') ? state.tgtPosNavKyd : {x:0,y:0};
    const relNav = { x: pNav.x - anchor.x, y: pNav.y - anchor.y };
    const distKyd = clamp(mag(relNav.x,relNav.y), 0, 35 * KNOT_TO_KYD_PER_HR * VECTOR_TIME_HR);

    let crs = distKyd > 1e-9 ? vecToCourse(relNav.x,relNav.y) : 0;
    if(snap5) crs = Math.round(crs/5)*5;

    const spKts = distKyd / (KNOT_TO_KYD_PER_HR * VECTOR_TIME_HR);
    const spKtsSnapped = Math.round(spKts * 2) / 2;

    const vecUnit = courseToVec(crs);
    const vecNav = {
      x: vecUnit.x * spKtsSnapped * KNOT_TO_KYD_PER_HR * VECTOR_TIME_HR,
      y: vecUnit.y * spKtsSnapped * KNOT_TO_KYD_PER_HR * VECTOR_TIME_HR
    };

    if(which==='R'){
      state.own.c = ((Math.round(crs)%360)+360)%360;
      state.own.s = spKtsSnapped;
    } else {
      state.tgt.c = ((Math.round(crs)%360)+360)%360;
      state.tgt.s = spKtsSnapped;

      const newPos = { x: pNav.x - vecNav.x, y: pNav.y - vecNav.y };
      setTgtPosPolarFromNav(newPos);
      resetSim();
    }
    render();
  }

  function startDrag(which, evt){
    dragging = which;
    evt.preventDefault();
    svg.setPointerCapture?.(evt.pointerId);
    if(which==='R') ptR.setAttribute('cursor','grabbing');
    if(which==='M') ptM.setAttribute('cursor','grabbing');
  }
  function endDrag(evt){
    dragging = null;
    ptR.setAttribute('cursor','grab');
    ptM.setAttribute('cursor','grab');
    try{ svg.releasePointerCapture?.(evt.pointerId); }catch(e){}
  }

  ptR.addEventListener('pointerdown',(e)=>startDrag('R',e));
  ptM.addEventListener('pointerdown',(e)=>startDrag('M',e));
  svg.addEventListener('pointermove',(evt)=>{
    if(!dragging) return;
    const p = svgPointFromEvent(evt);
    applyDrag(dragging, p, evt.shiftKey);
  });
  svg.addEventListener('pointerup', endDrag);
  svg.addEventListener('pointercancel', endDrag);
  svg.addEventListener('pointerleave', (evt)=>{ if(dragging) endDrag(evt); });

  // ---------- Animation loop ----------
  let last = performance.now();
  function tick(now){
    const dtSec = (now - last)/1000;
    last = now;

    if(state.sim.playing){
      const dtH = dtSec * state.sim.baseHoursPerSec * state.sim.speedMult;
      const {RMrate} = computeRatesKydHr();

      state.sim.contactNavKyd.x += RMrate.x * dtH;
      state.sim.contactNavKyd.y += RMrate.y * dtH;
      state.sim.tHours = clamp(state.sim.tHours + dtH, 0, 999);

      const curMin = Math.floor(state.sim.tHours*60);
      if(curMin - state.sim.lastTrailMin >= state.sim.trailEveryMin){
        state.sim.trailPtsKyd.push({ ...state.sim.contactNavKyd });
        if(state.sim.trailPtsKyd.length > 800) state.sim.trailPtsKyd.shift();
        state.sim.lastTrailMin = curMin;
      }

      render();
    }

    requestAnimationFrame(tick);
  }

  // ---------- Init ----------
  setTgtPosNavFromPolar();
  resetSim();
  render();
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
